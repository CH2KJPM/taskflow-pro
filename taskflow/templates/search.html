{% extends "base.html" %}

{% block content %}
  <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:1rem; margin-bottom:1.2rem;">
    <div>
      <h1 class="page-title">Recherche</h1>
      <p class="page-subtitle">
        R√©sultats pour ¬´ <strong>{{ q }}</strong> ¬ª ‚Äî {{ total_projects }} projet{{ 's' if total_projects != 1 }} et {{ total_tasks }} t√¢che{{ 's' if total_tasks != 1 }} trouv√©s.
      </p>
    </div>
    <div style="display:flex; gap:0.5rem; flex-wrap:wrap; justify-content:flex-end; align-items:center;">
      <a href="{{ url_for('main.dashboard') }}">
        <button class="btn btn-secondary">‚Üê Dashboard</button>
      </a>
      <form method="get"
            action="{{ url_for('main.search') }}"
            style="display:flex; align-items:center; gap:0.3rem;">
        <input type="text"
               name="q"
               value="{{ q }}"
               placeholder="Rechercher..."
               class="input"
               style="max-width:200px; padding:0.3rem 0.6rem; font-size:0.8rem;">
        <button type="submit"
                class="btn btn-secondary"
                style="font-size:0.75rem; padding:0.25rem 0.6rem;">
          üîç
        </button>
      </form>
    </div>
  </div>

  {% if total_projects == 0 and total_tasks == 0 %}
    <div class="card-soft">
      <p class="muted">
        Aucun r√©sultat trouv√© pour ¬´ {{ q }} ¬ª. <br>
        Essaie avec un autre mot-cl√© (titre de t√¢che, nom de projet, description‚Ä¶).
      </p>
    </div>
  {% else %}

    <!-- R√©sum√© -->
    <div class="card-soft" style="margin-bottom:1.2rem;">
      <div style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:center; justify-content:space-between;">
        <div style="display:flex; flex-wrap:wrap; gap:0.5rem;">
          <span class="pill" style="background:rgba(59,130,246,0.12); border-color:rgba(59,130,246,0.7); color:#bfdbfe;">
            {{ total_projects }} projet{{ 's' if total_projects != 1 }}
          </span>
          <span class="pill pill-medium">
            {{ general_tasks|length }} t√¢che{{ 's' if general_tasks|length != 1 }} g√©n√©rales
          </span>
          <span class="pill" style="background:rgba(236,72,153,0.12); border-color:rgba(236,72,153,0.7); color:#f9a8d4;">
            {{ content_tasks|length }} contenu{{ 's' if content_tasks|length != 1 }}
          </span>
        </div>
        <p class="muted" style="font-size:0.8rem;">
          Astuce : pense √† des mots-cl√©s pr√©cis (nom de client, format de vid√©o, type de t√¢che, etc.).
        </p>
      </div>
    </div>

    <div style="display:grid; grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr); gap:1rem; align-items:flex-start;">

      <!-- COLONNE GAUCHE : Projets -->
      <div class="card-soft">
        <h2 style="font-size:1.05rem; margin-top:0; margin-bottom:0.5rem;">Projets correspondants</h2>

        {% if projects %}
          <div class="projects-grid" style="margin-top:0.8rem;">
            {% for p in projects %}
              {% set open_tasks = p.tasks | selectattr("status", "ne", "done") | list %}
              <div class="project-card">
                <div class="project-card-title">{{ p.name }}</div>
                <div class="project-card-desc">
                  {% if p.description %}
                    {{ p.description }}
                  {% else %}
                    Pas de description pour ce projet.
                  {% endif %}
                </div>
                <div class="project-card-footer">
                  <span>
                    {{ open_tasks|length }} t√¢che{{ 's' if open_tasks|length != 1 }} ouverte{{ 's' if open_tasks|length != 1 }}
                  </span>
                  <a href="{{ url_for('main.project_detail', project_id=p.id) }}">
                    <button class="btn btn-secondary" style="font-size:0.8rem;">Ouvrir ‚Üí</button>
                  </a>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="muted">Aucun projet ne correspond √† cette recherche.</p>
        {% endif %}
      </div>

      <!-- COLONNE DROITE : T√¢ches -->
      <div class="card-soft">
        <h2 style="font-size:1.05rem; margin-top:0; margin-bottom:0.5rem;">T√¢ches correspondantes</h2>

        {% if general_tasks or content_tasks %}
          {% if general_tasks %}
            <h3 style="font-size:0.85rem; text-transform:uppercase; letter-spacing:0.08em; color:var(--text-muted); margin-top:0.4rem; margin-bottom:0.3rem;">
              T√¢ches g√©n√©rales
            </h3>
            {% for t in general_tasks %}
              <div class="task-card" style="margin-bottom:0.4rem;">
                <div class="task-title">{{ t.title }}</div>
                {% if t.description %}
                  <div style="font-size:0.78rem; color:var(--text-muted); margin-top:0.15rem;">
                    {{ t.description }}
                  </div>
                {% endif %}
                <div class="task-meta">
                  <div>
                    {% if t.priority == 'low' %}
                      <span class="pill pill-low">Basse</span>
                    {% elif t.priority == 'high' %}
                      <span class="pill pill-high">Haute</span>
                    {% else %}
                      <span class="pill pill-medium">Moyenne</span>
                    {% endif %}
                  </div>
                  <div class="task-date">
                    {% if t.project %}
                      Projet : {{ t.project.name }}
                    {% endif %}
                    {% if t.due_date %}
                      ‚Ä¢ √âch√©ance : {{ t.due_date.strftime("%d.%m.%Y") }}
                    {% endif %}
                  </div>
                </div>
                <div class="task-actions" style="margin-top:0.45rem;">
                  {% if t.status != 'done' %}
                    <form method="post"
                          action="{{ url_for('main.update_task_status', task_id=t.id, new_status='done') }}">
                      <button class="btn btn-primary" style="font-size:0.75rem;">‚úì Termin√©</button>
                    </form>
                  {% endif %}
                  <a href="{{ url_for('main.edit_task', task_id=t.id) }}">
                    <button type="button" class="btn btn-secondary" style="font-size:0.75rem;">Modifier</button>
                  </a>
                </div>
              </div>
            {% endfor %}
          {% endif %}

          {% if content_tasks %}
            <h3 style="font-size:0.85rem; text-transform:uppercase; letter-spacing:0.08em; color:var(--text-muted); margin-top:0.8rem; margin-bottom:0.3rem;">
              Contenus (mode cr√©ateur)
            </h3>
            {% for t in content_tasks %}
              <div class="task-card" style="margin-bottom:0.4rem;">
                <div class="task-title">{{ t.title }}</div>
                {% if t.description %}
                  <div style="font-size:0.78rem; color:var(--text-muted); margin-top:0.15rem;">
                    {{ t.description }}
                  </div>
                {% endif %}
                <div class="task-meta">
                  <div style="display:flex; gap:0.25rem; flex-wrap:wrap;">
                    {% if t.platform == "tiktok" %}
                      <span class="pill" style="background:rgba(248,113,113,0.12); border-color:rgba(248,113,113,0.7); color:#fecaca;">
                        TikTok
                      </span>
                    {% elif t.platform == "instagram" %}
                      <span class="pill" style="background:rgba(236,72,153,0.12); border-color:rgba(236,72,153,0.7); color:#f9a8d4;">
                        Instagram
                      </span>
                    {% elif t.platform == "youtube" %}
                      <span class="pill" style="background:rgba(248,113,113,0.12); border-color:rgba(239,68,68,0.8); color:#fecaca;">
                        YouTube
                      </span>
                    {% elif t.platform == "other" %}
                      <span class="pill" style="background:rgba(59,130,246,0.12); border-color:rgba(59,130,246,0.7); color:#bfdbfe;">
                        Multi / autre
                      </span>
                    {% endif %}

                    {% if t.priority == 'low' %}
                      <span class="pill pill-low">Basse</span>
                    {% elif t.priority == 'high' %}
                      <span class="pill pill-high">Haute</span>
                    {% else %}
                      <span class="pill pill-medium">Moyenne</span>
                    {% endif %}
                  </div>
                  <div class="task-date">
                    {% if t.project %}
                      {{ t.project.name }}
                    {% endif %}
                    {% if t.due_date %}
                      ‚Ä¢ {{ t.due_date.strftime("%d.%m.%Y") }}
                    {% endif %}
                  </div>
                </div>
                <div class="task-actions" style="margin-top:0.45rem;">
                  {% if t.status != 'done' %}
                    <form method="post"
                          action="{{ url_for('main.update_task_status', task_id=t.id, new_status='done') }}">
                      <button class="btn btn-primary" style="font-size:0.75rem;">‚úì Termin√©</button>
                    </form>
                  {% endif %}
                  <a href="{{ url_for('main.edit_task', task_id=t.id) }}">
                    <button type="button" class="btn btn-secondary" style="font-size:0.75rem;">Modifier</button>
                  </a>
                </div>
              </div>
            {% endfor %}
          {% endif %}
        {% else %}
          <p class="muted">Aucune t√¢che ne correspond √† cette recherche.</p>
        {% endif %}
      </div>

    </div>
  {% endif %}
{% endblock %}