{% extends "base.html" %}

{% block content %}
  <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:1rem; margin-bottom:1.2rem;">
    <div>
      <h1 class="page-title">Modifier la tâche</h1>
      <p class="page-subtitle">
        Projet : <strong>{{ project.name }}</strong>
      </p>
    </div>
    <div style="display:flex; gap:0.5rem; flex-wrap:wrap; justify-content:flex-end;">
      <a href="{{ url_for('main.project_detail', project_id=project.id) }}">
        <button class="btn btn-secondary">← Retour au projet</button>
      </a>
    </div>
  </div>

  <div class="card-soft">
    <form method="post"
          action="{{ url_for('main.edit_task', task_id=task.id) }}"
          style="display:grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap:0.9rem; align-items:flex-start;">

      <!-- Colonne 1 : titre + description -->
      <div>
        <div class="field">
          <label for="title">Titre de la tâche</label>
          <input id="title"
                 name="title"
                 type="text"
                 class="input"
                 required
                 value="{{ task.title }}">
        </div>

        <div class="field">
          <label for="description">Description (optionnel)</label>
          <textarea id="description"
                    name="description"
                    class="textarea"
                    rows="4">{{ task.description or "" }}</textarea>
        </div>
      </div>

      <!-- Colonne 2 : priorité / date / type -->
      <div>
        <div class="field">
          <label for="priority">Priorité</label>
          <select id="priority" name="priority" class="select">
            <option value="low" {% if task.priority == "low" %}selected{% endif %}>Basse</option>
            <option value="medium" {% if task.priority == "medium" %}selected{% endif %}>Moyenne</option>
            <option value="high" {% if task.priority == "high" %}selected{% endif %}>Haute</option>
          </select>
        </div>

        <div class="field">
          <label for="due_date">Date limite (optionnel)</label>
          <input id="due_date"
                 name="due_date"
                 type="date"
                 class="input"
                 value="{% if task.due_date %}{{ task.due_date.strftime('%Y-%m-%d') }}{% endif %}">
        </div>

        <div class="field">
          <label for="task_type">Type de tâche</label>
          <select id="task_type" name="task_type" class="select">
            <option value="general"
                    {% if not task.task_type or task.task_type == "general" %}selected{% endif %}>
              Général
            </option>
            <option value="content"
                    {% if task.task_type == "content" %}selected{% endif %}>
              Contenu (vidéo, reel, short…)
            </option>
          </select>
        </div>
      </div>

      <!-- Colonne 3 : options créateur -->
      <div id="content-options" style="display:none;">
        <div class="field">
          <label for="platform">Plateforme</label>
          <select id="platform" name="platform" class="select">
            <option value="">Choisir…</option>
            <option value="tiktok" {% if task.platform == "tiktok" %}selected{% endif %}>TikTok</option>
            <option value="instagram" {% if task.platform == "instagram" %}selected{% endif %}>Instagram</option>
            <option value="youtube" {% if task.platform == "youtube" %}selected{% endif %}>YouTube</option>
            <option value="other" {% if task.platform == "other" %}selected{% endif %}>Autre / multi</option>
          </select>
        </div>

        <div class="field">
          <label for="creator_stage">Étape du contenu</label>
          <select id="creator_stage" name="creator_stage" class="select">
            <option value="" {% if not task.creator_stage %}selected{% endif %}>Non défini</option>
            <option value="idea" {% if task.creator_stage == "idea" %}selected{% endif %}>Idée</option>
            <option value="to_film" {% if task.creator_stage == "to_film" %}selected{% endif %}>À filmer</option>
            <option value="to_edit" {% if task.creator_stage == "to_edit" %}selected{% endif %}>À monter</option>
            <option value="scheduled" {% if task.creator_stage == "scheduled" %}selected{% endif %}>Programmé</option>
            <option value="published" {% if task.creator_stage == "published" %}selected{% endif %}>Publié</option>
          </select>
        </div>

        <p class="muted" style="font-size:0.75rem; margin-top:0.3rem;">
          Ces champs sont utiles si cette tâche correspond à une vidéo ou un contenu à publier.
        </p>
      </div>

      <!-- Boutons -->
      <div style="display:flex; flex-direction:column; justify-content:flex-end; gap:0.5rem;">
        <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
        <a href="{{ url_for('main.project_detail', project_id=project.id) }}">
          <button type="button" class="btn btn-secondary">Annuler</button>
        </a>
      </div>
    </form>
  </div>

  <script>
    // Affiche / masque les options "créateur" selon le type sélectionné
    document.addEventListener("DOMContentLoaded", function () {
      const typeSelect = document.getElementById("task_type");
      const contentOptions = document.getElementById("content-options");

      function toggleContentOptions() {
        if (!typeSelect || !contentOptions) return;

        if (typeSelect.value === "content") {
          contentOptions.style.display = "block";
        } else {
          contentOptions.style.display = "none";
        }
      }

      if (typeSelect) {
        typeSelect.addEventListener("change", toggleContentOptions);
        // Init en fonction de la valeur actuelle (si tâche déjà "content")
        toggleContentOptions();
      }
    });
  </script>
{% endblock %}
